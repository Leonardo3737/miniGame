<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    canvas {
      border: 1px black solid
    }
  </style>
  <script src="entities/Player.js"></script>
  <script src="entities/Game.js"></script>
  <script src="controls/KeyboardInput.js"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>

<body>
  <canvas id="screenGame" width="600" height="600"></canvas>

  <script>
    const socket = io()
    const screenGame = document.getElementById('screenGame')
    const genericBody = screenGame.getContext('2d')
    const game = new Game(screenGame, genericBody)

    const keyboardInput = new KeyboardInput(document)

    let player

    /* document.addEventListener('DOMContentLoaded', () => {
      keyboardInput.subscribe(key => {
        socket.emit('test', 'asd')
        game.movementEvent(key, player2.id)
      })
      game.renderGame()
    }) */

    socket.on('new-player', ({ idPlayer, position, players }) => {
      if (!player) {
        player = new Player(idPlayer, genericBody, position.x, position.y, game, true)
        game.addPlayer(player)
        keyboardInput.subscribe(key => movementPlayer(key, idPlayer))
      }

      players.map(p => {
        if (p.idPlayer === player.id) return

        let auxPlayer = new Player(p.idPlayer, genericBody, p.position.x, p.position.y, game, false)
        game.addPlayer(auxPlayer)
      })

      game.updateScreen()
    })

    socket.on('exit-player', (idPlayer) => {
      game.removePlayer(idPlayer)
    })

    socket.on('update-screen', (players)=> {
      players.map(p => {
        if (p.idPlayer === player.id) return

        game.removePlayer(p.idPlayer)
        let auxPlayer = new Player(p.idPlayer, genericBody, p.position.x, p.position.y, game, false)
        game.addPlayer(auxPlayer)
      })
      game.updateScreen()
    })

    function movementPlayer(key, idPlayer) {
      game.movementEvent(key, idPlayer)
      const obj = {
        idPlayer,
        position: {
          x: player.posX,
          y: player.posY
        }
      }
      socket.emit('mov-player', obj)
    }

  </script>
</body>

</html>